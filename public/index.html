<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game of Life</title>
    <link rel="stylesheet" type="text/css" href="./css/style.css">
</head>
<body>
    <h1>Game of Life</h1>
    <p>The Game of Life is not your typical computer game. It is a 'cellular automaton', and was invented by Cambridge
        mathematician John Conway.</p>
    <canvas id="gameCanvas" width="1200" height="1000"></canvas>
    <form>
        <select id="shapes" onchange="loadShape(this.value)">
            <option>Glider</option>
            <option>Small Exploder</option>
            <option>Exploder</option>
            <option>Ten Cell Row</option>
            <option>Infinite</option>
            <option>Pulsar</option>
        </select>
        <button type="button" onclick="simulate()">Next</button>
        <input id="days" type="number" value="1" min="1" size="1"/>
        <input id="speed" type="range" step="1" min="1" max="10"/>
        <button type="button" onclick="clear()">Clear</button>
        <label id="daysCount">0</label>
    </form>

    <!--<script src="./js/game.js" type="text/javascript"></script>-->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const board = [];

        ctx.strokeStyle = 'black';
        ctx.fillStyle = 'blue';
        const sqrSize = 20;
        canvas.addEventListener('click', onMouseClick, false);
        //////////////////////////////////////////////////////////////////
        var scaleFactor = 1.1;
        var lastX=canvas.width/2, lastY=canvas.height/2;
        var zoom = function(){
            ctx.translate(lastX,lastY);
            ctx.scale(1.5,1.5);
            ctx.translate(-lastX,-lastY);
            draw(board);
        };

        var handleScroll = function(evt){
            console.log('Scrolled');
            var delta = evt.wheelDelta ? evt.wheelDelta/40 : evt.detail ? -evt.detail : 0;
            if (delta) zoom();
            return evt.preventDefault() && false;
        };
        canvas.addEventListener('DOMMouseScroll',handleScroll,false);
        canvas.addEventListener('mousewheel',handleScroll,false);

        function setEventHandlers() {
            socket.on('boardChanged', onBoardChanged);
        }

        function onBoardChanged(board) {
            draw(board);
            console.log('Board changed');
            window.board = board;
        }

        function draw(board) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            board.forEach(function(row, x) {
                row.forEach(function(cell, y) {
                    ctx.beginPath();
                    ctx.rect(y*sqrSize, x*sqrSize, sqrSize, sqrSize);
                    if (cell) {
                        ctx.fill();
                    } else {
                        ctx.stroke();
                    }
                });
            });
        }

        function loadShape(shape) {
            socket.emit('loadShape', shape);
        }

        function simulate() {
            const days = parseInt(document.getElementById('days').value);
            const speed = parseInt(document.getElementById('speed').value);
            socket.emit('simulate', {days, speed});
        }

        function clear() {
            console.log(':(');
            socket.emit('clear');
            console.log('Haide de');
        }

        function onMouseClick(event) {
            const rect = canvas.getBoundingClientRect();
            const y = Math.floor((event.clientX - rect.left) / sqrSize);
            const x = Math.floor((event.clientY - rect.top) / sqrSize);
            console.log(x, y);
            socket.emit('newCell', {x, y});
        }
        setEventHandlers();
    </script>
</body>
</html>